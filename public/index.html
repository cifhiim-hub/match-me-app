<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MatchMe Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; background: #0f172a; color: #f1f5f9; margin: 0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        .page { display: none; padding: 20px; padding-bottom: 100px; }
        .active { display: block; }
        .input-box { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 12px; width: 100%; color: white; margin-bottom: 10px; outline: none; }
        .btn-blue { background: #3b82f6; color: white; font-weight: bold; border-radius: 12px; padding: 14px; width: 100%; border: none; cursor: pointer; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); height: 70px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 100; }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-[#0f172a] z-[999] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-blue-500 mb-4"></div>
        <p class="text-blue-400 text-sm">MATCHME ××ª×—×‘×¨...</p>
    </div>

    <div id="page-feed" class="page active">
        <h1 class="text-2xl font-extrabold mb-6">MATCH<span class="text-blue-500">ME</span></h1>
        <div id="list-container" class="space-y-4"></div>
    </div>

    <div id="page-post" class="page">
        <h2 class="text-xl font-bold mb-4">×¤×¨×¡×•× ××•×“×¢×” ×—×“×©×”</h2>
        <input type="text" id="p-title" placeholder="×›×•×ª×¨×ª ×”××©×¨×” (×œ××©×œ: × ×”×’ ×—×œ×•×§×”)" class="input-box">
        <input type="text" id="p-name" placeholder="×©× ×”×¢×¡×§" class="input-box">
        <input type="text" id="p-city" placeholder="×¢×™×¨" class="input-box">
        <input type="tel" id="p-phone" placeholder="××¡×¤×¨ ×•×•××˜×¡××¤ (05...)" class="input-box">
        <textarea id="p-desc" placeholder="×ª×™××•×¨ ×”××©×¨×”..." class="input-box h-24"></textarea>
        
        <div class="glass p-4 mb-4">
            <p class="text-xs font-bold text-blue-400 mb-2">×©××œ×•×ª ×¡×™× ×•×Ÿ (×›×Ÿ/×œ×):</p>
            <div id="q-container" class="space-y-2">
                <input type="text" class="q-input input-box text-sm mb-0" placeholder="×©××œ×” 1 (×œ××©×œ: ×™×© ×¨×™×©×™×•×Ÿ ×’'?)">
            </div>
            <button onclick="UI.addQ()" class="text-blue-500 text-xs font-bold mt-2">+ ×”×•×¡×£ ×©××œ×”</button>
        </div>
        
        <button onclick="Data.save()" class="btn-blue">×¤×¨×¡× ×‘×œ×•×— ğŸš€</button>
    </div>

    <div id="page-quiz" class="page flex-col justify-center text-center">
        <h2 id="quiz-text" class="text-2xl font-bold mb-10 px-4"></h2>
        <div class="grid grid-cols-2 gap-4 px-4">
            <button onclick="App.answer(true)" class="btn-blue py-8 text-xl">×›×Ÿ</button>
            <button onclick="App.answer(false)" class="bg-slate-700 rounded-xl py-8 text-xl font-bold">×œ×</button>
        </div>
    </div>

    <nav class="nav-bar">
        <div onclick="Nav.go('feed')">ğŸ </div>
        <div onclick="Nav.go('post')">â•</div>
        <div onclick="Nav.go('admin')">ğŸ‘¤</div>
    </nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ×”×§×•× ×¤×™×’×•×¨×¦×™×” ×”××“×•×™×§×ª ××”×¦×™×œ×•× ××¡×š ×©×œ×š
    const firebaseConfig = {
        apiKey: "AIzaSyD0hsz8SOI1OG2Fh-DBy1SHeabPaEKZx-Y",
        authDomain: "matchme-32bcf.firebaseapp.com",
        projectId: "matchme-32bcf",
        storageBucket: "matchme-32bcf.firebasestorage.app",
        messagingSenderId: "1082863959305",
        appId: "1:1082863959305:web:d8da5ea69af003602c27d8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let State = { user: null, posts: [], activePost: null, qIdx: 0, score: 0 };

    const UI = {
        loader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; },
        addQ() {
            const i = document.createElement('input');
            i.className = "q-input input-box text-sm";
            i.placeholder = "×©××œ×” × ×•×¡×¤×ª...";
            document.getElementById('q-container').appendChild(i);
        },
        renderFeed(data) {
            document.getElementById('list-container').innerHTML = data.map(p => `
                <div class="glass p-5" onclick="App.startApply('${p.id}')">
                    <h3 class="text-lg font-bold">${p.title}</h3>
                    <p class="text-blue-400 text-sm">${p.name} | ${p.city}</p>
                    <div class="mt-4 text-[10px] opacity-50 font-bold italic">×œ×—×¥ ×œ×”×’×©×ª ××•×¢××“×•×ª ×•×©××œ×•×Ÿ ></div>
                </div>
            `).join('');
        }
    };

    const Data = {
        async load() {
            UI.loader(true);
            try {
                const s = await getDocs(query(collection(db, "posts"), orderBy("createdAt", "desc")));
                State.posts = s.docs.map(d => ({id: d.id, ...d.data()}));
                UI.renderFeed(State.posts);
            } catch(e) { console.error(e); }
            UI.loader(false);
        },
        async save() {
            const title = document.getElementById('p-title').value;
            const phone = document.getElementById('p-phone').value;
            const qs = Array.from(document.querySelectorAll('.q-input')).map(i => i.value).filter(v => v);
            
            if(!title || phone.length < 9) return alert("××œ× ×›×•×ª×¨×ª ×•×˜×œ×¤×•×Ÿ ×ª×§×™×Ÿ");
            
            UI.loader(true);
            try {
                await addDoc(collection(db, "posts"), {
                    title, name: document.getElementById('p-name').value,
                    city: document.getElementById('p-city').value,
                    phone: phone.replace(/\D/g,''),
                    desc: document.getElementById('p-desc').value,
                    questions: qs,
                    owner: State.user?.uid || 'guest',
                    createdAt: serverTimestamp()
                });
                location.reload();
            } catch(e) { alert("×©×’×™××” ×‘×©××™×¨×”: ×•×•×“× ×©×—×•×§×™ ×”××‘×˜×—×” ×‘-Firebase ×××•×©×¨×™×"); }
        }
    };

    const App = {
        startApply(id) {
            State.activePost = State.posts.find(p => p.id === id);
            if(State.activePost.questions && State.activePost.questions.length > 0) {
                State.qIdx = 0; State.score = 0;
                Nav.go('quiz');
                App.showQ();
            } else {
                App.finish(100);
            }
        },
        showQ() {
            document.getElementById('quiz-text').innerText = State.activePost.questions[State.qIdx];
        },
        answer(v) {
            if(v) State.score += (100 / State.activePost.questions.length);
            State.qIdx++;
            if(State.qIdx < State.activePost.questions.length) App.showQ();
            else App.finish(Math.round(State.score));
        },
        async finish(score) {
            const p = State.activePost;
            const msg = encodeURIComponent(`×”×™×™, ×× ×™ ××¢×•× ×™×™×Ÿ ×‘××©×¨×”: ${p.title}. ×¦×™×•×Ÿ ×”×ª×××” ×‘×©××œ×•×Ÿ: ${score}%`);
            // ×ª×™×§×•×Ÿ ×œ×™× ×§ ×•×•××˜×¡××¤ ×œ×¤×•×¨××˜ ××•× ×™×‘×¨×¡×œ×™
            window.location.href = `https://api.whatsapp.com/send?phone=972${p.phone.substring(1)}&text=${msg}`;
        }
    };

    const Nav = { go(p) {
        document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        if(p === 'feed') Data.load();
    }};

    onAuthStateChanged(auth, u => { State.user = u; });
    window.UI = UI; window.Data = Data; window.Nav = Nav; window.App = App;
    Data.load();
</script>
</body>
</html>
