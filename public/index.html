<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatchMe | Personal Area</title>
    <style>
        :root { --blue: #0052cc; --dark: #2c3e50; --green: #2ecc71; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 500px; min-height: 85vh; }
        .section { display: none; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .btn { width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-dark { background: var(--dark); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-outline { background: white; border: 2px solid #ddd; color: var(--dark); }
        .card { background: white; border: 1px solid #eee; padding: 15px; margin-bottom: 12px; border-radius: 12px; border-right: 6px solid var(--blue); position: relative; }
        input, textarea { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .delete-btn { position: absolute; left: 10px; top: 10px; color: #ff4d4d; cursor: pointer; font-size: 12px; border: 1px solid #ff4d4d; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align:center; margin-bottom:25px;" onclick="location.hash=''; location.reload();">
        <h1 style="color:var(--blue); margin:0;">MatchMe ğŸš€</h1>
        <small id="userGreeting"></small>
    </header>

    <div id="mainStep" class="section active">
        <button class="btn btn-blue" onclick="showSection('workerSearchJobs')">ğŸ‘· ×× ×™ ×¢×•×‘×“ (×—×¤×© ××©×¨×”)</button>
        <button class="btn btn-dark" onclick="showSection('employerLogin')">ğŸ’¼ ×× ×™ ××¢×¡×™×§ (××–×•×¨ ××™×©×™)</button>
    </div>

    <div id="employerLogin" class="section">
        <h3>×”×ª×—×‘×¨×•×ª ××¢×¡×™×§</h3>
        <p>×”×›× ×¡ ××ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×©×œ×š ×›×“×™ ×œ×¨××•×ª ××ª ×”××©×¨×•×ª ×•×”×¤× ×™×•×ª ×©×œ×š:</p>
        <input type="tel" id="employerPhoneLogin" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ (×œ××©×œ 0501234567)">
        <button class="btn btn-dark" onclick="loginEmployer()">×”×™×›× ×¡ ×œ××–×•×¨ ×”××™×©×™</button>
        <button class="btn btn-outline" onclick="showSection('mainStep')">×—×–×•×¨</button>
    </div>

    <div id="employerDashboard" class="section">
        <h3 id="dashTitle">×”××–×•×¨ ×©×œ×™</h3>
        <button class="btn btn-blue" onclick="showSection('employerPostJob')">â• ×¤×¨×¡× ××©×¨×” ×—×“×©×”</button>
        <button class="btn btn-green" onclick="loadPersonalLeads()">ğŸ“‹ ×¤× ×™×•×ª ××¢×•×‘×“×™× ××œ×™</button>
        <hr>
        <h4>×”××©×¨×•×ª ×”×¤×¢×™×œ×•×ª ×©×œ×™:</h4>
        <div id="myJobsList"></div>
        <button class="btn btn-outline" onclick="logout()">×”×ª× ×ª×§</button>
    </div>

    <div id="workerSearchJobs" class="section">
        <h3>××©×¨×•×ª ×¤× ×•×™×•×ª</h3>
        <div id="allJobsContainer"></div>
    </div>

    <div id="employerPostJob" class="section">
        <h3>×¤×¨×¡× ××©×¨×”</h3>
        <input type="text" id="jTitle" placeholder="×ª×¤×§×™×“ ×”××©×¨×”">
        <input type="text" id="jCity" placeholder="×¢×™×¨">
        <input type="text" id="jSalary" placeholder="×©×›×¨">
        <textarea id="jDesc" placeholder="×ª×™××•×¨ ×”××©×¨×”..."></textarea>
        <div id="qBox"><input type="text" class="q-input" placeholder="×©××œ×ª ×¡×™× ×•×Ÿ (×œ××©×œ: ×™×© ×¨×™×©×™×•×Ÿ?)"></div>
        <button onclick="addQ()" style="background:none; border:none; color:var(--blue); cursor:pointer;">+ ×”×•×¡×£ ×©××œ×”</button>
        <button class="btn btn-blue" onclick="saveJob()">×¤×¨×¡× ×¢×›×©×™×•</button>
    </div>

    <div id="employerLeads" class="section">
        <h3>×¤× ×™×•×ª ×©×”×ª×§×‘×œ×• ××¦×œ×™</h3>
        <div id="myLeadsContainer"></div>
        <button class="btn btn-outline" onclick="showSection('employerDashboard')">×—×–×•×¨</button>
    </div>

    <div id="interviewSection" class="section">
        <div id="questionText" style="background:#e7efff; padding:25px; border-radius:15px; text-align:center; font-weight:bold; font-size:20px;"></div>
        <button class="btn btn-blue" onclick="handleAnswer(true)">âœ… ×›×Ÿ</button>
        <button class="btn btn-blue" onclick="handleAnswer(false)">âŒ ×œ×</button>
    </div>

    <div id="resultSection" class="section">
        <div id="resultArea"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD0hsz8SOI1O...", 
        authDomain: "matchme-32bcf.firebaseapp.com",
        projectId: "matchme-32bcf",
        storageBucket: "matchme-32bcf.appspot.com",
        messagingSenderId: "1082863959305",
        appId: "1:1082863959305:web:f888f4df815598696c601f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentEmployer = localStorage.getItem('employerPhone') || null;
    let currentJob = null; let score = 0; let qIdx = 0;

    // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×§×™×©×•×¨ ×•×•××˜×¡××¤ ×ª×§×™×Ÿ
    window.openWhatsApp = (phone, msg) => {
        let clean = phone.replace(/\D/g, ''); // ××©××™×¨ ×¨×§ ××¡×¤×¨×™×
        if (clean.startsWith('0')) clean = '972' + clean.substring(1);
        window.open(`https://wa.me/${clean}?text=${encodeURIComponent(msg)}`);
    };

    window.showSection = (id, push = true) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'workerSearchJobs') loadAllJobs();
        if(id === 'employerDashboard') loadMyJobs();
    };

    // ×”×ª×—×‘×¨×•×ª ××¢×¡×™×§
    window.loginEmployer = () => {
        const phone = document.getElementById('employerPhoneLogin').value;
        if(phone.length < 9) return alert("××¡×¤×¨ ×œ× ×ª×§×™×Ÿ");
        localStorage.setItem('employerPhone', phone);
        currentEmployer = phone;
        showSection('employerDashboard');
    };

    window.logout = () => { localStorage.removeItem('employerPhone'); location.reload(); };

    // ×˜×¢×™× ×ª ××©×¨×•×ª ××™×©×™×•×ª ×œ××¢×¡×™×§
    async function loadMyJobs() {
        const c = document.getElementById('myJobsList');
        c.innerHTML = '×˜×•×¢×Ÿ...';
        const q = query(collection(db, "jobs"), where("bossPhone", "==", currentEmployer));
        const snap = await getDocs(q);
        c.innerHTML = '';
        snap.forEach(d => {
            const j = d.data();
            c.innerHTML += `<div class="card">
                <div class="delete-btn" onclick="deleteJob('${d.id}')">××—×§</div>
                <b>${j.title}</b><br><small>${j.city}</small>
            </div>`;
        });
    }

    window.deleteJob = async (id) => {
        if(confirm("×œ××—×•×§ ××©×¨×”?")) { await deleteDoc(doc(db, "jobs", id)); loadMyJobs(); }
    };

    // ×¤×¨×¡×•× ××©×¨×” ×¢× ×©×™×•×š ×œ××¢×¡×™×§
    window.saveJob = async () => {
        const j = {
            title: document.getElementById('jTitle').value,
            city: document.getElementById('jCity').value,
            bossPhone: currentEmployer,
            questions: Array.from(document.getElementsByClassName('q-input')).map(i=>i.value).filter(v=>v),
            createdAt: new Date()
        };
        await addDoc(collection(db, "jobs"), j);
        alert("×¤×•×¨×¡× ×‘××–×•×¨ ×”××™×©×™ ×©×œ×š!");
        showSection('employerDashboard');
    };

    // ×˜×¢×™× ×ª ×¤× ×™×•×ª (×¨×§ ××œ×• ×©× ×©×œ×—×• ×œ××¢×¡×™×§ ×”× ×•×›×—×™)
    window.loadPersonalLeads = async () => {
        showSection('employerLeads');
        const c = document.getElementById('myLeadsContainer');
        c.innerHTML = '×˜×•×¢×Ÿ ×¤× ×™×•×ª...';
        const q = query(collection(db, "leads"), where("bossPhone", "==", currentEmployer));
        const snap = await getDocs(q);
        c.innerHTML = '';
        snap.forEach(d => {
            const l = d.data();
            const div = document.createElement('div');
            div.className = 'card';
            div.style.borderRightColor = 'var(--green)';
            div.innerHTML = `<b>${l.workerName}</b> (${l.score}%)<br>××©×¨×”: ${l.jobTitle}`;
            const btn = document.createElement('button');
            btn.className = 'btn btn-green';
            btn.innerText = '×©×œ×— ×•×•××˜×¡××¤ ×œ×¢×•×‘×“';
            btn.onclick = () => openWhatsApp(l.workerPhone, `×”×™×™ ${l.workerName}, ×¨××™×ª×™ ×©×¤× ×™×ª ×œ××©×¨×” ×©×œ×™ ×‘-MatchMe...`);
            div.appendChild(btn);
            c.appendChild(div);
        });
    };

    // ×˜×¢×™× ×ª ××©×¨×•×ª ×œ×¢×•×‘×“ (×”×›×œ)
    async function loadAllJobs() {
        const c = document.getElementById('allJobsContainer');
        const snap = await getDocs(query(collection(db, "jobs"), orderBy("createdAt", "desc")));
        c.innerHTML = '';
        snap.forEach(d => {
            const j = d.data();
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `<h3>${j.title}</h3><p>${j.city}</p>`;
            div.onclick = () => { currentJob = {id: d.id, ...j}; startApplication(); };
            c.appendChild(div);
        });
    }

    // ×”×’×©×ª ××•×¢××“×•×ª
    function startApplication() {
        const name = prompt("×”×›× ×¡ ×©× ××œ×:");
        const phone = prompt("×”×›× ×¡ ×˜×œ×¤×•×Ÿ:");
        if(!name || !phone) return;
        currentJob.workerName = name;
        currentJob.workerPhone = phone;
        score = 0; qIdx = 0;
        showSection('interviewSection');
        ask();
    }

    function ask() { document.getElementById('questionText').innerText = currentJob.questions[qIdx]; }

    window.handleAnswer = async (isYes) => {
        if(isYes) score += (100 / currentJob.questions.length);
        qIdx++;
        if(qIdx < currentJob.questions.length) ask();
        else {
            const final = Math.round(score);
            // ×©××™×¨×ª ×”×œ×™×“ ×¢× ×©×™×•×š ×œ××¢×¡×™×§ ×”×¡×¤×¦×™×¤×™
            await addDoc(collection(db, "leads"), {
                bossPhone: currentJob.bossPhone,
                jobTitle: currentJob.title,
                workerName: currentJob.workerName,
                workerPhone: currentJob.workerPhone,
                score: final,
                createdAt: new Date()
            });
            
            showSection('resultSection');
            document.getElementById('resultArea').innerHTML = `
                <div style="text-align:center;">
                    <h2>×”×ª×××”: ${final}%</h2>
                    <button class="btn btn-green" onclick="openWhatsApp('${currentJob.bossPhone}', '×”×™×™, ×¢×‘×¨×ª×™ ×¡×™× ×•×Ÿ ×‘-MatchMe!')">×©×œ×— ×•×•××˜×¡××¤ ×œ××¢×¡×™×§</button>
                    <button class="btn btn-outline" onclick="location.reload()">×¡×™×•×</button>
                </div>`;
        }
    }

    window.addQ = () => { document.getElementById('qBox').innerHTML += '<input type="text" class="q-input" placeholder="×©××œ×” × ×•×¡×¤×ª...">'; };

    // ×‘×“×™×§×” ×× ×›×‘×¨ ××—×•×‘×¨
    if(currentEmployer) showSection('employerDashboard');
</script>
</body>
</html>
