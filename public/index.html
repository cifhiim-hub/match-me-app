<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatchMe | ×”××¢×¨×›×ª ×”××œ××”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --blue: #0052cc; --dark: #1a202c; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .section { display: none; animation: slideUp 0.4s ease; }
        .active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .match-card { transition: transform 0.2s; border-right: 4px solid var(--blue); }
        .match-card:hover { transform: translateY(-3px); }
        .loader { border-top-color: #0052cc; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-2 md:p-6">

<div class="max-w-2xl mx-auto bg-white rounded-3xl shadow-xl p-5 min-h-[90vh] relative overflow-hidden">
    
    <header class="flex justify-between items-center mb-8 pb-4 border-b">
        <h1 class="text-3xl font-black text-blue-700 cursor-pointer" onclick="goHome()">MatchMe</h1>
        <div id="userBadge" class="hidden text-xs bg-blue-50 px-3 py-1 rounded-full font-bold text-blue-600"></div>
    </header>

    <div id="mainStep" class="section active text-center">
        <img src="https://illustrations.popsy.co/blue/work-from-home.svg" class="w-48 mx-auto mb-8">
        <h2 class="text-2xl font-bold mb-6">××™×š ×ª×¨×¦×” ×œ×”×©×ª××© ×‘××¤×œ×™×§×¦×™×”?</h2>
        <div class="space-y-4">
            <button onclick="checkAuth('worker')" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-bold text-lg shadow-lg hover:bg-blue-700">ğŸ‘· ×× ×™ ××—×¤×© ×¢×‘×•×“×” (×¢×•×‘×“)</button>
            <button onclick="checkAuth('employer')" class="w-full border-2 border-gray-800 p-5 rounded-2xl font-bold text-lg hover:bg-gray-800 hover:text-white transition">ğŸ’¼ ×× ×™ ××’×™×™×¡ ×¢×•×‘×“×™× (××¢×¡×™×§)</button>
        </div>
    </div>

    <div id="authSection" class="section">
        <h3 id="authTitle" class="text-2xl font-bold mb-6 text-center">×”×ª×—×‘×¨×•×ª</h3>
        <div class="space-y-3">
            <input type="email" id="authEmail" placeholder="××™××™×™×œ" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
            <input type="password" id="authPass" placeholder="×¡×™×¡××”" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
            <div class="flex gap-2">
                <button onclick="handleAuth('login')" class="flex-1 bg-blue-600 text-white p-4 rounded-xl font-bold">×”×ª×—×‘×¨</button>
                <button onclick="handleAuth('register')" class="flex-1 bg-gray-100 p-4 rounded-xl font-bold">×”×¨×©× ×›×—×“×©</button>
            </div>
            <button onclick="resetPass()" class="w-full text-sm text-blue-600 underline py-2">×©×›×—×ª×™ ×¡×™×¡××”</button>
        </div>
    </div>

    <div id="workerDashboard" class="section">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">×”×¤×¨×•×¤×™×œ ×©×œ×™</h3>
            <button onclick="logout()" class="text-red-500 font-bold text-sm">×”×ª× ×ª×§</button>
        </div>
        <button onclick="showSection('workerSearch')" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold mb-8 shadow-md">ğŸ” ×—×¤×© ××©×¨×•×ª ×—×“×©×•×ª</button>
        
        <h4 class="font-bold border-b pb-2 mb-4">×”×™×¡×˜×•×¨×™×™×ª ×”×’×©×•×ª ××•×¢××“×•×ª:</h4>
        <div id="workerHistory" class="space-y-3 text-sm italic text-gray-400">××™×Ÿ ×”×’×©×•×ª ×¢×“×™×™×Ÿ...</div>
    </div>

    <div id="employerDashboard" class="section">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">× ×™×”×•×œ ×’×™×•×¡</h3>
            <button onclick="logout()" class="text-red-500 font-bold text-sm">×”×ª× ×ª×§</button>
        </div>
        <button onclick="showSection('postJob')" class="w-full bg-green-500 text-white p-4 rounded-xl font-bold mb-6 shadow-md">+ ×¤×¨×¡× ××©×¨×” ×—×“×©×”</button>
        
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="bg-gray-50 p-4 rounded-xl border">
                <div class="text-xs text-gray-500">××©×¨×•×ª ×¤×¢×™×œ×•×ª</div>
                <div id="countJobs" class="text-2xl font-black">0</div>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl border">
                <div class="text-xs text-gray-500">×¤× ×™×•×ª ×©×§×™×‘×œ×ª</div>
                <div id="countLeads" class="text-2xl font-black">0</div>
            </div>
        </div>

        <div id="employerContent" class="space-y-6">
            <div>
                <h4 class="font-bold mb-3">×”××©×¨×•×ª ×©×œ×™:</h4>
                <div id="myJobsList" class="space-y-2"></div>
            </div>
            <div>
                <h4 class="font-bold mb-3">×¢×•×‘×“×™× ×©×¤× ×• ××œ×™×š:</h4>
                <div id="myLeadsList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <div id="postJob" class="section">
        <h3 class="text-xl font-bold mb-4">×¤×¨×¡×•× ××©×¨×”</h3>
        <div class="space-y-3">
            <input type="text" id="jTitle" placeholder="×©× ×”×ª×¤×§×™×“" class="w-full p-3 border rounded-xl">
            <input type="text" id="jCity" placeholder="×¢×™×¨" class="w-full p-3 border rounded-xl">
            <input type="text" id="jSalary" placeholder="×©×›×¨ (×œ××©×œ: 45â‚ª ×œ×©×¢×”)" class="w-full p-3 border rounded-xl">
            <textarea id="jDesc" placeholder="×ª×™××•×¨ ×”××©×¨×” ×•×“×¨×™×©×•×ª..." class="w-full p-3 border rounded-xl h-24"></textarea>
            
            <div class="bg-blue-50 p-4 rounded-xl">
                <label class="font-bold text-blue-700 block mb-2">×©××œ×•×ª ×¡×™× ×•×Ÿ (×›×Ÿ/×œ×):</label>
                <div id="qBox" class="space-y-2">
                    <input type="text" class="q-input w-full p-2 border rounded-lg bg-white" placeholder="×©××œ×” 1 (×œ××©×œ: ×™×© ×œ×š ×¨×™×©×™×•×Ÿ?)">
                </div>
                <button onclick="addQ()" class="text-blue-600 text-xs font-bold mt-2">+ ×”×•×¡×£ ×©××œ×”</button>
            </div>
            <button onclick="saveJob()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg mt-4">×¤×¨×¡× ×¢×›×©×™×•</button>
        </div>
    </div>

    <div id="workerSearch" class="section">
        <h3 class="text-xl font-bold mb-4">××©×¨×•×ª ××ª××™××•×ª</h3>
        <div id="allJobs" class="space-y-4"></div>
        <button onclick="showSection('workerDashboard')" class="w-full mt-8 text-gray-400">×—×–×¨×” ×œ×¤×¨×•×¤×™×œ</button>
    </div>

    <div id="interview" class="section">
        <div class="text-center mb-8">
            <div id="qCount" class="text-xs text-blue-500 font-bold mb-2"></div>
            <div id="qText" class="text-2xl font-black bg-blue-50 p-8 rounded-3xl border-2 border-blue-100"></div>
        </div>
        <div class="flex gap-4">
            <button onclick="handleAnswer(true)" class="flex-1 bg-green-500 text-white p-6 rounded-2xl text-xl font-bold shadow-lg">×›×Ÿ</button>
            <button onclick="handleAnswer(false)" class="flex-1 bg-red-500 text-white p-6 rounded-2xl text-xl font-bold shadow-lg">×œ×</button>
        </div>
    </div>

    <div id="result" class="section text-center py-10">
        <div id="resultIcon" class="text-6xl mb-4"></div>
        <h2 id="resultTitle" class="text-3xl font-black mb-4"></h2>
        <p id="resultMsg" class="mb-8 text-gray-600 px-6"></p>
        <button onclick="goHome()" class="bg-blue-600 text-white px-10 py-3 rounded-full font-bold">×¡×™×•×</button>
    </div>

    <div id="loader" class="hidden absolute inset-0 bg-white/90 z-50 flex items-center justify-center rounded-3xl">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-14 w-14"></div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD0hsz8SOI1O...", 
        authDomain: "matchme-32bcf.firebaseapp.com",
        projectId: "matchme-32bcf",
        storageBucket: "matchme-32bcf.appspot.com",
        messagingSenderId: "1082863959305",
        appId: "1:1082863959305:web:f888f4df815598696c601f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let userRole = null; // 'worker' or 'employer'
    let currentJob = null;
    let qIdx = 0;
    let score = 0;

    // --- AUTH LOGIC ---
    window.handleAuth = async (type) => {
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPass').value;
        if (!email || pass.length < 6) return alert("××™×™×œ ×ª×§×™×Ÿ ×•×¡×™×¡××” ××¢×œ 6 ×ª×•×•×™×");

        loading(true);
        try {
            let res;
            if (type === 'register') {
                res = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", res.user.uid), { role: userRole, email });
            } else {
                res = await signInWithEmailAndPassword(auth, email, pass);
            }
            routeUser(res.user.uid);
        } catch (e) { alert("×©×’×™××”: " + e.message); loading(false); }
    };

    onAuthStateChanged(auth, async (u) => {
        if (u) {
            currentUser = u;
            const userDoc = await getDoc(doc(db, "users", u.uid));
            userRole = userDoc.data()?.role;
            document.getElementById('userBadge').innerText = userRole === 'employer' ? '××¢×¡×™×§' : '×¢×•×‘×“';
            document.getElementById('userBadge').classList.remove('hidden');
        } else {
            currentUser = null;
            document.getElementById('userBadge').classList.add('hidden');
        }
    });

    window.checkAuth = (role) => {
        userRole = role;
        if (currentUser) routeUser(currentUser.uid);
        else showSection('authSection');
    };

    const routeUser = async (uid) => {
        const userDoc = await getDoc(doc(db, "users", uid));
        const role = userDoc.data()?.role;
        loading(false);
        showSection(role === 'employer' ? 'employerDashboard' : 'workerDashboard');
    };

    window.logout = () => signOut(auth).then(() => location.reload());
    window.resetPass = () => {
        const email = document.getElementById('authEmail').value;
        if(email) sendPasswordResetEmail(auth, email).then(()=>alert("××™×™×œ ×©×—×–×•×¨ × ×©×œ×—!"));
    };

    // --- GENERAL UI ---
    window.showSection = (id) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'workerDashboard') loadWorkerHistory();
        if(id === 'employerDashboard') { loadMyJobs(); loadMyLeads(); }
        if(id === 'workerSearch') loadAllJobs();
    };
    window.goHome = () => showSection('mainStep');
    const loading = (s) => document.getElementById('loader').classList.toggle('hidden', !s);

    // --- EMPLOYER LOGIC ---
    window.addQ = () => {
        const i = document.createElement('input');
        i.className = 'q-input w-full p-2 border rounded-lg bg-white mt-2';
        i.placeholder = '×©××œ×” × ×•×¡×¤×ª...';
        document.getElementById('qBox').appendChild(i);
    };

    window.saveJob = async () => {
        const j = {
            ownerId: currentUser.uid,
            title: document.getElementById('jTitle').value,
            city: document.getElementById('jCity').value,
            salary: document.getElementById('jSalary').value,
            desc: document.getElementById('jDesc').value,
            questions: Array.from(document.getElementsByClassName('q-input')).map(i=>i.value).filter(v=>v),
            createdAt: new Date()
        };
        loading(true);
        await addDoc(collection(db, "jobs"), j);
        loading(false);
        showSection('employerDashboard');
    };

    async function loadMyJobs() {
        const c = document.getElementById('myJobsList');
        const q = query(collection(db, "jobs"), where("ownerId", "==", currentUser.uid));
        const snap = await getDocs(q);
        c.innerHTML = "";
        document.getElementById('countJobs').innerText = snap.size;
        snap.forEach(d => {
            const data = d.data();
            c.innerHTML += `<div class="p-3 bg-white border rounded-xl flex justify-between items-center text-sm shadow-sm">
                <span><b>${data.title}</b> | ${data.city}</span>
                <button onclick="deleteJob('${d.id}')" class="text-red-400">ğŸ—‘ï¸</button>
            </div>`;
        });
    }

    async function loadMyLeads() {
        const c = document.getElementById('myLeadsList');
        const q = query(collection(db, "leads"), where("bossId", "==", currentUser.uid), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        c.innerHTML = snap.empty ? "<p class='text-xs text-gray-400'>××™×Ÿ ×¤× ×™×•×ª ×¢×“×™×™×Ÿ</p>" : "";
        document.getElementById('countLeads').innerText = snap.size;
        snap.forEach(d => {
            const l = d.data();
            c.innerHTML += `<div class="p-3 bg-blue-50 border-r-4 border-blue-400 rounded-lg flex justify-between items-center text-sm">
                <div><b>${l.workerName}</b> (${l.score}%)<br><span class="text-xs text-gray-500">${l.jobTitle}</span></div>
                <button onclick="window.open('https://wa.me/${l.workerPhone}')" class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold">WhatsApp</button>
            </div>`;
        });
    }

    window.deleteJob = async (id) => { if(confirm("×œ××—×•×§ ××©×¨×”?")) { await deleteDoc(doc(db, "jobs", id)); loadMyJobs(); } };

    // --- WORKER LOGIC ---
    async function loadAllJobs() {
        const c = document.getElementById('allJobs');
        loading(true);
        const snap = await getDocs(query(collection(db, "jobs"), orderBy("createdAt", "desc")));
        loading(false);
        c.innerHTML = "";
        snap.forEach(d => {
            const j = d.data();
            c.innerHTML += `<div onclick='startInterview(${JSON.stringify({id: d.id, ...j})})' class="match-card bg-white p-5 rounded-2xl border shadow-sm cursor-pointer">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-black text-blue-900">${j.title}</h4>
                    <span class="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded-full">${j.salary}</span>
                </div>
                <p class="text-xs text-gray-500 mb-2">ğŸ“ ${j.city}</p>
                <p class="text-xs text-gray-600 line-clamp-2">${j.desc}</p>
            </div>`;
        });
    }

    async function loadWorkerHistory() {
        const c = document.getElementById('workerHistory');
        const q = query(collection(db, "leads"), where("workerId", "==", currentUser.uid), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        c.innerHTML = "";
        if(snap.empty) { c.innerHTML = "××™×Ÿ ×”×’×©×•×ª ×¢×“×™×™×Ÿ..."; return; }
        snap.forEach(d => {
            const l = d.data();
            const date = l.createdAt.toDate().toLocaleDateString('he-IL');
            c.innerHTML += `<div class="p-3 bg-gray-50 rounded-xl border flex justify-between items-center text-xs text-gray-700">
                <span><b>${l.jobTitle}</b> - ${date}</span>
                <span class="${l.score > 70 ? 'text-green-600' : 'text-orange-500'} font-bold">${l.score}%</span>
            </div>`;
        });
    }

    window.startInterview = (job) => {
        const name = prompt("×©× ××œ×:");
        const phone = prompt("×˜×œ×¤×•×Ÿ (×œ×œ× ××§×¤×™×):");
        if (!name || !phone) return;
        currentJob = job;
        currentJob.workerName = name;
        currentJob.workerPhone = phone;
        qIdx = 0; score = 0;
        showSection('interview');
        nextQ();
    };

    function nextQ() {
        if (qIdx < currentJob.questions.length) {
            document.getElementById('qCount').innerText = `×©××œ×” ${qIdx+1} ××ª×•×š ${currentJob.questions.length}`;
            document.getElementById('qText').innerText = currentJob.questions[qIdx];
        } else { finish(); }
    }

    window.handleAnswer = (ans) => {
        if (ans) score += (100 / currentJob.questions.length);
        qIdx++;
        nextQ();
    };

    async function finish() {
        const final = Math.round(score);
        loading(true);
        await addDoc(collection(db, "leads"), {
            bossId: currentJob.ownerId,
            workerId: currentUser.uid,
            jobTitle: currentJob.title,
            workerName: currentJob.workerName,
            workerPhone: currentJob.workerPhone,
            score: final,
            createdAt: new Date()
        });
        loading(false);
        
        showSection('result');
        const win = final >= 70;
        document.getElementById('resultIcon').innerText = win ? "ğŸ‰" : "ğŸ“©";
        document.getElementById('resultTitle').innerText = win ? "×–×” Match!" : "×”×¤× ×™×™×” × ×©×œ×—×”";
        document.getElementById('resultMsg').innerText = win ? 
            `×¢×‘×¨×ª ××ª ×”×¡×™× ×•×Ÿ ×‘×¦×™×•×Ÿ ${final}! ×”××¢×¡×™×§ ×§×™×‘×œ ××ª ×”×¤×¨×˜×™× ×©×œ×š ×•×™×—×–×•×¨ ××œ×™×š ×‘×§×¨×•×‘.` : 
            `×¡×™×™××ª ××ª ×”×©××œ×•×Ÿ ×‘×¦×™×•×Ÿ ${final}. ×”××¢×¡×™×§ ×™×‘×—×Ÿ ××ª ×”×¤×¨×˜×™× ×©×œ×š ×•×™×—×œ×™×˜ ×× ×œ×”×ª×§×“×.`;
    }
</script>
</body>
</html>
