<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatchMe | ×”×’×¨×¡×” ×”×™×¡×•×“×™×ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --main-blue: #2563eb; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f1f5f9; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        input:focus, textarea:focus { border-color: var(--main-blue); outline: none; ring: 2px var(--main-blue); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-12">

<div class="max-w-xl mx-auto glass min-h-screen shadow-2xl relative">
    
    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md p-4 border-b flex justify-between items-center">
        <h1 class="text-2xl font-black text-blue-600 tracking-tighter cursor-pointer" onclick="goHome()">MatchMe</h1>
        <div id="userTag" class="text-[10px] bg-slate-100 px-2 py-1 rounded-full text-slate-500 font-mono italic">Guest_Session</div>
    </nav>

    <div id="mainStep" class="section active p-6">
        <div class="text-center py-8">
            <h2 class="text-3xl font-extrabold text-slate-800 mb-2">××¦× ×¢×‘×•×“×” ×‘-3 ×œ×—×™×¦×•×ª</h2>
            <p class="text-slate-500 mb-8">×¡×™× ×•×Ÿ ×—×›×, ×¤× ×™×™×” ×™×©×™×¨×”, ×œ×œ× ×‘×™×¨×•×§×¨×˜×™×”.</p>
            
            <div class="grid gap-4">
                <button onclick="showSection('workerSearch')" class="group relative flex items-center justify-center p-6 bg-blue-600 text-white rounded-2xl font-bold text-xl shadow-xl hover:bg-blue-700 transition-all">
                    <span>ğŸ” ×—×¤×© ××©×¨×” ×¢×›×©×™×•</span>
                </button>
                
                <button onclick="showSection('employerGate')" class="flex items-center justify-center p-6 bg-white border-2 border-slate-200 text-slate-700 rounded-2xl font-bold text-xl hover:border-blue-500 transition-all">
                    <span>ğŸ’¼ ××–×•×¨ ××¢×¡×™×§×™×</span>
                </button>
            </div>
        </div>
    </div>

    <div id="workerSearch" class="section p-4">
        <div class="mb-6 space-y-2">
            <input type="text" id="searchInput" onkeyup="filterJobs()" placeholder="×—×¤×© ×ª×¤×§×™×“ ××• ×¢×™×¨..." class="w-full p-4 rounded-xl border-2 border-slate-100 shadow-sm">
            <div class="flex gap-2 overflow-x-auto py-2 no-scrollbar">
                <span onclick="setFilter('××œ×¦×¨')" class="bg-white px-3 py-1 rounded-full text-xs border cursor-pointer">××œ×¦×¨×•×ª</span>
                <span onclick="setFilter('× ×”×’')" class="bg-white px-3 py-1 rounded-full text-xs border cursor-pointer">× ×”×’×™×</span>
                <span onclick="setFilter('××›×™×¨×•×ª')" class="bg-white px-3 py-1 rounded-full text-xs border cursor-pointer">××›×™×¨×•×ª</span>
                <span onclick="setFilter('')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-bold cursor-pointer">×”×›×œ</span>
            </div>
        </div>
        <div id="jobList" class="space-y-4">
            </div>
    </div>

    <div id="employerGate" class="section p-6 text-center">
        <h3 class="text-2xl font-bold mb-6">× ×™×”×•×œ ×’×™×•×¡</h3>
        <div class="space-y-3">
            <button onclick="showSection('postJob')" class="w-full p-4 bg-green-600 text-white rounded-xl font-bold shadow-lg">â• ×¤×¨×¡× ××©×¨×” ×—×“×©×”</button>
            <button onclick="checkEmployerLogin()" class="w-full p-4 bg-slate-800 text-white rounded-xl font-bold">ğŸ“‹ ×”××©×¨×•×ª ×•×”×¤× ×™×•×ª ×©×œ×™</button>
        </div>
        <button onclick="goHome()" class="mt-8 text-slate-400 text-sm underline">×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª</button>
    </div>

    <div id="postJob" class="section p-6">
        <h3 class="text-xl font-bold mb-4">×¤×¨×˜×™ ×”××©×¨×”</h3>
        <div class="space-y-3">
            <div>
                <label class="text-xs font-bold text-slate-400 mr-1">×›×•×ª×¨×ª ×”×ª×¤×§×™×“</label>
                <input type="text" id="jTitle" placeholder="×œ××©×œ: × ×”×’ ×—×œ×•×§×” ×¢×“ 12 ×˜×•×Ÿ" class="w-full p-3 border rounded-xl">
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="text-xs font-bold text-slate-400 mr-1">×¢×™×¨</label>
                    <input type="text" id="jCity" placeholder="×ª×œ ××‘×™×‘" class="w-full p-3 border rounded-xl">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 mr-1">×©×›×¨ (×©×¢×”/×—×•×“×©)</label>
                    <input type="text" id="jSalary" placeholder="50â‚ª ×œ×©×¢×”" class="w-full p-3 border rounded-xl">
                </div>
            </div>
            <input type="tel" id="jPhone" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×§×‘×œ×ª ×¤× ×™×•×ª (×•×•××˜×¡××¤)" class="w-full p-3 border rounded-xl">
            <textarea id="jDesc" placeholder="×ª×™××•×¨ ×§×¦×¨ ×©×œ ×”××©×¨×”..." class="w-full p-3 border rounded-xl h-24"></textarea>
            
            <div class="p-4 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200">
                <p class="text-xs font-bold text-blue-600 mb-2">×©××œ×•×ª ×¡×™× ×•×Ÿ (×¢×•×–×¨ ×œ×—×¡×•×š ×–××Ÿ):</p>
                <div id="qBox" class="space-y-2">
                    <input type="text" class="q-input w-full p-2 text-sm border rounded-lg" placeholder="×©××œ×” 1: ×™×© ×œ×š ×¨×™×©×™×•×Ÿ ××ª××™×?">
                </div>
                <button onclick="addQuestionField()" class="text-[10px] text-slate-500 mt-2 hover:text-blue-600">+ ×”×•×¡×£ ×©××œ×” × ×•×¡×¤×ª</button>
            </div>
            
            <button onclick="publishJob()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold text-lg shadow-xl">×¤×¨×¡× ×¢×›×©×™×•</button>
        </div>
    </div>

    <div id="interview" class="section p-6">
        <div class="mb-8">
            <div id="progress" class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
        <div id="qDisplay" class="text-2xl font-black text-center py-12 text-slate-800"></div>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="answer(true)" class="p-8 bg-green-500 text-white rounded-2xl font-bold text-2xl shadow-lg">×›×Ÿ</button>
            <button onclick="answer(false)" class="p-8 bg-red-500 text-white rounded-2xl font-bold text-2xl shadow-lg">×œ×</button>
        </div>
    </div>

    <div id="employerDashboard" class="section p-4">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-xl">× ×™×”×•×œ ×”××©×¨×•×ª ×©×œ×™</h3>
            <button onclick="logout()" class="text-xs text-red-500">×”×ª× ×ª×§</button>
        </div>
        <div id="myJobs" class="space-y-4"></div>
    </div>

    <div id="loading" class="hidden absolute inset-0 bg-white/80 z-[100] flex items-center justify-center rounded-3xl">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyD0hsz8SOI1O...", authDomain: "matchme-32bcf.firebaseapp.com", projectId: "matchme-32bcf", storageBucket: "matchme-32bcf.appspot.com", messagingSenderId: "1082863959305", appId: "1:1082863959305:web:f888f4df815598696c601f" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let user = null;
    let currentJob = null;
    let qIdx = 0;
    let score = 0;
    let allJobsRaw = [];

    // --- Core Logic ---
    onAuthStateChanged(auth, u => {
        user = u;
        document.getElementById('userTag').innerText = u ? u.email.split('@')[0] : "Guest_Session";
    });

    window.showSection = (id) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'workerSearch') fetchJobs();
        if(id === 'employerDashboard') fetchMyJobs();
    };

    window.goHome = () => showSection('mainStep');
    const toggleLoader = (show) => document.getElementById('loading').classList.toggle('hidden', !show);

    // --- Job Management ---
    window.addQuestionField = () => {
        const input = document.createElement('input');
        input.className = "q-input w-full p-2 text-sm border rounded-lg mt-2";
        input.placeholder = "×©××œ×” × ×•×¡×¤×ª...";
        document.getElementById('qBox').appendChild(input);
    };

    window.publishJob = async () => {
        const title = document.getElementById('jTitle').value;
        const phone = document.getElementById('jPhone').value;
        if(!title || phone.length < 9) return alert("×× × ××œ× ×›×•×ª×¨×ª ×•×˜×œ×¤×•×Ÿ ×ª×§×™×Ÿ");

        toggleLoader(true);
        try {
            await addDoc(collection(db, "jobs"), {
                title,
                city: document.getElementById('jCity').value,
                salary: document.getElementById('jSalary').value,
                phone: phone.replace(/\D/g,''),
                desc: document.getElementById('jDesc').value,
                questions: Array.from(document.getElementsByClassName('q-input')).map(i => i.value).filter(v => v),
                ownerId: user ? user.uid : 'anonymous',
                createdAt: serverTimestamp()
            });
            alert("×”××©×¨×” ×¤×•×¨×¡××”!");
            goHome();
        } catch(e) { console.error(e); }
        toggleLoader(false);
    };

    async function fetchJobs() {
        toggleLoader(true);
        const snap = await getDocs(query(collection(db, "jobs"), orderBy("createdAt", "desc")));
        allJobsRaw = snap.docs.map(d => ({id: d.id, ...d.data()}));
        renderJobs(allJobsRaw);
        toggleLoader(false);
    }

    function renderJobs(jobs) {
        const c = document.getElementById('jobList');
        c.innerHTML = jobs.length ? "" : "<p class='text-center text-slate-400 py-10'>×œ× × ××¦××• ××©×¨×•×ª</p>";
        jobs.forEach(j => {
            const hasApplied = localStorage.getItem(`applied_${j.id}`);
            c.innerHTML += `
                <div onclick="startApply('${j.id}')" class="p-4 bg-white rounded-2xl border-2 ${hasApplied ? 'border-slate-100 opacity-60' : 'border-white shadow-sm hover:border-blue-200'} transition-all cursor-pointer">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-slate-800">${j.title}</h4>
                        <span class="text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded-lg">${j.salary || '×©×›×¨ ×œ× ×¦×•×™×Ÿ'}</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">ğŸ“ ${j.city}</p>
                    ${hasApplied ? '<span class="text-[9px] text-green-600 font-bold mt-2 inline-block">âœ“ ×›×‘×¨ ×¤× ×™×ª ×œ××©×¨×” ×–×•</span>' : ''}
                </div>
            `;
        });
    }

    // --- Search & Filter ---
    window.filterJobs = () => {
        const val = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allJobsRaw.filter(j => 
            j.title.toLowerCase().includes(val) || j.city.toLowerCase().includes(val)
        );
        renderJobs(filtered);
    };

    window.setFilter = (val) => {
        document.getElementById('searchInput').value = val;
        filterJobs();
    };

    // --- Apply & Interview ---
    window.startApply = (id) => {
        if(localStorage.getItem(`applied_${id}`)) return alert("×›×‘×¨ ×”×’×©×ª ××•×¢××“×•×ª ×œ××©×¨×” ×–×•.");
        currentJob = allJobsRaw.find(j => j.id === id);
        const name = prompt("××™×š ×§×•×¨××™× ×œ×š?");
        if(!name) return;
        currentJob.applicantName = name;
        
        if(currentJob.questions && currentJob.questions.length > 0) {
            qIdx = 0; score = 0;
            showSection('interview');
            showQ();
        } else {
            submitLead(100);
        }
    };

    function showQ() {
        document.getElementById('qDisplay').innerText = currentJob.questions[qIdx];
        document.getElementById('progressBar').style.width = `${(qIdx / currentJob.questions.length) * 100}%`;
    }

    window.answer = (ans) => {
        if(ans) score += (100 / currentJob.questions.length);
        qIdx++;
        if(qIdx < currentJob.questions.length) showQ();
        else submitLead(Math.round(score));
    };

    async function submitLead(finalScore) {
        toggleLoader(true);
        await addDoc(collection(db, "leads"), {
            jobId: currentJob.id,
            bossId: currentJob.ownerId,
            jobTitle: currentJob.title,
            applicantName: currentJob.applicantName,
            score: finalScore,
            createdAt: serverTimestamp()
        });
        localStorage.setItem(`applied_${currentJob.id}`, "true");
        toggleLoader(false);
        
        const msg = `×”×™×™, ×× ×™ ${currentJob.applicantName}, ×”×’×©×ª×™ ××•×¢××“×•×ª ×œ××©×¨×ª ${currentJob.title} ×•×§×™×‘×œ×ª×™ ×¦×™×•×Ÿ ×”×ª×××” ×©×œ ${finalScore}%`;
        window.open(`https://wa.me/972${currentJob.phone.substring(1)}?text=${encodeURIComponent(msg)}`);
        goHome();
    }

    // --- Employer Dashboard Logic ---
    window.checkEmployerLogin = () => {
        if(user) showSection('employerDashboard');
        else {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).then(() => showSection('employerDashboard'));
        }
    };

    async function fetchMyJobs() {
        toggleLoader(true);
        const q = query(collection(db, "jobs"), where("ownerId", "==", user.uid));
        const snap = await getDocs(q);
        const c = document.getElementById('myJobs');
        c.innerHTML = "";
        snap.forEach(d => {
            const j = d.data();
            c.innerHTML += `
                <div class="p-4 bg-slate-50 rounded-xl border">
                    <div class="flex justify-between">
                        <h4 class="font-bold">${j.title}</h4>
                        <button onclick="delJob('${d.id}')" class="text-red-500 text-xs">××—×§</button>
                    </div>
                </div>
            `;
        });
        toggleLoader(false);
    }
</script>
</body>
</html>
